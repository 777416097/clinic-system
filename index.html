<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام محاسبة الأطباء | هيئة مستشفى الثورة - إب</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #005a32; --accent: #2c3e50; --success: #28a745; --danger: #dc3545; --warning: #f39c12; }
        body { font-family: 'Cairo', sans-serif; background: #f0f4f7; margin: 0; padding: 15px; }
        .container { max-width: 1250px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-top: 6px solid var(--primary); }
        
        /* الترويسة الرسمية */
        .gov-header { text-align: center; margin-bottom: 20px; border-bottom: 2px double #ddd; padding-bottom: 15px; }
        .gov-header h3 { margin: 5px 0; color: var(--accent); }
        .gov-header h2 { margin: 5px 0; color: var(--primary); font-size: 1.6rem; }

        /* نظام التبويبات (Menu Tabs) */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 12px 25px; border: none; background: #e2e8f0; color: var(--accent); border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* تنسيق النماذج */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f9f9f9; padding: 25px; border-radius: 12px; border: 1px solid #eee; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #eef7f2; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #c8e6c9; }
        
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 0.85rem; font-weight: bold; color: #555; margin-bottom: 5px; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Cairo'; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(0,90,50,0.2); }

        .btn-panel { display: flex; gap: 10px; margin-top: 20px; }
        button.action-btn { flex: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; font-size: 1rem; }
        .btn-save { background: var(--primary); }
        .btn-update { background: var(--warning); display: none; }
        .btn-excel { background: var(--accent); }

        /* الجدول */
        .table-container { overflow-x: auto; background: white; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: var(--accent); color: white; padding: 15px; font-size: 0.9rem; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        
        .alert { display: none; background: #fff5f5; color: #c0392b; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #feb2b2; text-align: center; font-weight: bold; }
        .fav-btn { cursor: pointer; font-size: 1.3rem; color: #ddd; }
        .fav-btn.active { color: #f1c40f; }
        .delete-icon { color: var(--danger); cursor: pointer; margin-right: 12px; }
        .edit-icon { color: #3498db; cursor: pointer; }
        .badge { background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 6px; font-weight: bold; border: 1px solid #c3e6cb; }
        .search-box { border: 2px solid var(--primary) !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="gov-header">
        <h3>الجمهورية اليمنية</h3>
        <h2>هيئة مستشفى الثورة التعليمي - محافظة إب</h2>
        <h3>نظام أتمتة مستحقات الأطباء</h3>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab('input-tab', this)">
            <i class="fas fa-edit"></i> قائمة الإدخال
        </button>
        <button class="tab-btn" onclick="openTab('report-tab', this)">
            <i class="fas fa-file-invoice"></i> قائمة التقارير والبحث
        </button>
    </div>

    <div id="duplicateAlert" class="alert">
        <i class="fas fa-exclamation-triangle"></i> تنبيه: رقم السند هذا مسجل مسبقاً!
    </div>

    <div id="input-tab" class="tab-content active">
        <div class="form-grid">
            <input type="hidden" id="editKey">
            <div class="input-group"><label>اسم المريض</label><input type="text" id="pName" placeholder="الاسم الرباعي"></div>
            <div class="input-group"><label>نوع العملية</label><input type="text" id="pType" placeholder="نوع الإجراء"></div>
            <div class="input-group"><label>اسم الطبيب</label><input type="text" id="dName" placeholder="الطبيب المختص"></div>
            <div class="input-group"><label>رقم السند</label><input type="number" id="rId" placeholder="0000"></div>
            <div class="input-group"><label>مبلغ السند</label><input type="number" id="rAmount" placeholder="0.00"></div>
            <div class="input-group"><label>تاريخ السند</label><input type="date" id="rDate"></div>
        </div>
        <div class="btn-panel">
            <button id="saveBtn" class="action-btn btn-save" onclick="handleSave()"><i class="fas fa-plus-circle"></i> حفظ السند في السحابة</button>
            <button id="updateBtn" class="action-btn btn-update" onclick="handleUpdate()"><i class="fas fa-sync-alt"></i> تحديث التعديلات</button>
        </div>
    </div>

    <div id="report-tab" class="tab-content">
        <div class="filter-grid">
            <div class="input-group">
                <label><i class="fas fa-search"></i> البحث السريع (اسم الطبيب)</label>
                <input type="text" id="filterDoctor" class="search-box" placeholder="ابحث عن طبيب..." onkeyup="filterTable()">
            </div>
            <div class="input-group"><label>الفترة من</label><input type="date" id="filterDateFrom"></div>
            <div class="input-group"><label>الفترة إلى</label><input type="date" id="filterDateTo"></div>
            <div class="input-group" style="justify-content: flex-end;">
                <button class="action-btn btn-excel" onclick="exportExcelFiltered()"><i class="fas fa-file-excel"></i> ترحيل التقرير الرسمي</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><i class="fas fa-star"></i></th>
                        <th>التاريخ</th>
                        <th>رقم السند</th>
                        <th>المريض</th>
                        <th>الطبيب</th>
                        <th>المبلغ</th>
                        <th>النسبة 35%</th>
                        <th>الصافي</th>
                        <th>خيارات</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC58hO1JLETcYKPgWbUpo6lQKAVlHNNCAQ",
        authDomain: "my-mohammed-777.firebaseapp.com",
        databaseURL: "https://my-mohammed-777-default-rtdb.firebaseio.com",
        projectId: "my-mohammed-777",
        storageBucket: "my-mohammed-777.firebasestorage.app",
        messagingSenderId: "579967755436",
        appId: "1:579967755436:web:ae30d06bb9acf51437eb09",
        measurementId: "G-KX2LKBKHP8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let localData = [];

    document.getElementById('rDate').valueAsDate = new Date();

    // نظام التبديل بين القوائم
    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    // جلب البيانات
    db.ref('entries').on('value', (snapshot) => {
        const data = snapshot.val();
        localData = [];
        if (data) {
            Object.keys(data).forEach(key => {
                const item = data[key];
                item.firebaseKey = key;
                localData.push(item);
            });
        }
        renderTable(localData);
    });

    function renderTable(dataArray) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        dataArray.sort((a,b) => new Date(b.rDate) - new Date(a.rDate));
        dataArray.forEach(item => {
            const row = `
                <tr>
                    <td><i class="fas fa-star fav-btn ${item.isFav ? 'active' : ''}" onclick="toggleFav('${item.firebaseKey}', ${item.isFav})"></i></td>
                    <td>${item.rDate}</td>
                    <td><b>${item.rId}</b></td>
                    <td>${item.pName}</td>
                    <td>${item.dName}</td>
                    <td>${item.rAmount}</td>
                    <td>${item.docShare}</td>
                    <td><span class="badge">${item.netTotal}</span></td>
                    <td>
                        <i class="fas fa-edit edit-icon" title="تعديل" onclick="prepareEdit('${item.firebaseKey}')"></i>
                        <i class="fas fa-trash-alt delete-icon" title="حذف" onclick="deleteItem('${item.firebaseKey}')"></i>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    function filterTable() {
        const searchTerm = document.getElementById('filterDoctor').value.toLowerCase();
        const filtered = localData.filter(item => item.dName.toLowerCase().includes(searchTerm));
        renderTable(filtered);
    }

    function handleSave() {
        const rId = document.getElementById('rId').value;
        const rAmount = parseFloat(document.getElementById('rAmount').value);
        const pName = document.getElementById('pName').value;
        const dName = document.getElementById('dName').value;
        const rDate = document.getElementById('rDate').value;

        if (!rId || !rAmount || !pName || !dName) return alert("يرجى ملء كافة البيانات");

        if (localData.some(entry => entry.rId === rId)) {
            document.getElementById('duplicateAlert').style.display = 'block';
            setTimeout(() => document.getElementById('duplicateAlert').style.display = 'none', 4000);
            return;
        }

        const calc = calculateShares(rAmount);
        db.ref('entries').push({
            pName, pType: document.getElementById('pType').value,
            dName, rId, rAmount, rDate, ...calc, isFav: false
        }).then(() => {
            clearInputs();
            alert("تم الحفظ بنجاح");
        });
    }

    function calculateShares(amount) {
        const docShare = (amount * 0.35).toFixed(2);
        const tax = (docShare * 0.15).toFixed(2);
        const netTotal = (docShare - tax).toFixed(2);
        return { docShare, taxAmount: tax, netTotal };
    }

    function exportExcelFiltered() {
        const drFilter = document.getElementById('filterDoctor').value.toLowerCase();
        const from = document.getElementById('filterDateFrom').value;
        const to = document.getElementById('filterDateTo').value;

        let filtered = localData.filter(i => i.dName.toLowerCase().includes(drFilter));
        if (from && to) filtered = filtered.filter(i => i.rDate >= from && i.rDate <= to);
        if (filtered.length === 0) return alert("لا يوجد بيانات للترحيل");

        let sumOriginal = 0, sumNet = 0;
        const rows = [
            ["الجمهورية اليمنية"],
            ["هيئة مستشفى الثورة التعليمي - إب"],
            ["كشف مستحقات: " + (drFilter || "عام")],
            ["بتاريخ: " + new Date().toLocaleDateString('ar-YE')],
            [],
            ["التاريخ", "رقم السند", "المريض", "الطبيب", "المبلغ الكلي", "النسبة 35%", "الضريبة 15%", "الصافي"]
        ];

        filtered.forEach(item => {
            sumOriginal += parseFloat(item.rAmount);
            sumNet += parseFloat(item.netTotal);
            rows.push([item.rDate, item.rId, item.pName, item.dName, item.rAmount, item.docShare, item.taxAmount, item.netTotal]);
        });

        rows.push([], ["الإجمــــــــاليات", "", "", "", sumOriginal.toFixed(2), "", "", sumNet.toFixed(2)]);
        rows.push([], []);
        rows.push(["محاسب النسب", "مدير الإيرادات", "مدير الحسابات", "مدير عام المالية", "", "رئيس الهيئة"]);
        rows.push(["................", "................", "................", "................", "", "................"]);

        const ws = XLSX.utils.aoa_to_sheet(rows);
        ws['!cols'] = [{wch:15}, {wch:12}, {wch:22}, {wch:22}, {wch:15}, {wch:15}, {wch:15}, {wch:15}];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "التقرير الرسمي");
        XLSX.writeFile(wb, `تقرير_مستشفى_الثورة_${new Date().getTime()}.xlsx`);
    }

    function prepareEdit(key) {
        const item = localData.find(i => i.firebaseKey === key);
        document.getElementById('editKey').value = key;
        document.getElementById('pName').value = item.pName;
        document.getElementById('pType').value = item.pType;
        document.getElementById('dName').value = item.dName;
        document.getElementById('rId').value = item.rId;
        document.getElementById('rAmount').value = item.rAmount;
        document.getElementById('rDate').value = item.rDate;
        
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('updateBtn').style.display = 'flex';
        
        openTab('input-tab', document.querySelector('.nav-tabs button:first-child'));
    }

    function handleUpdate() {
        const key = document.getElementById('editKey').value;
        const rAmount = parseFloat(document.getElementById('rAmount').value);
        const calc = calculateShares(rAmount);
        db.ref('entries/' + key).update({
            pName: document.getElementById('pName').value,
            pType: document.getElementById('pType').value,
            dName: document.getElementById('dName').value,
            rId: document.getElementById('rId').value,
            rAmount: rAmount,
            rDate: document.getElementById('rDate').value,
            ...calc
        }).then(() => {
            alert("تم التحديث");
            clearInputs();
            document.getElementById('saveBtn').style.display = 'flex';
            document.getElementById('updateBtn').style.display = 'none';
        });
    }

    function deleteItem(key) { if(confirm("حذف نهائي؟")) db.ref('entries/' + key).remove(); }
    function toggleFav(key, current) { db.ref('entries/' + key).update({ isFav: !current }); }
    function clearInputs() {
        document.querySelectorAll('.form-grid input').forEach(i => { if(i.id !== 'rDate') i.value = ''; });
        document.getElementById('editKey').value = '';
    }
</script>
</body>
</html>
